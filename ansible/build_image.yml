---
# Play 1: Gather SSH key from the user running the playbook
- name: Gather local user SSH key
  hosts: "{{ target_host | default('localhost') }}"
  become: false
  vars_files:
    - vars/main.yml
    - "hardware_vars/{{ hardware_version }}.yml"
  tasks:
    - name: Set real user dir fact
      ansible.builtin.set_fact:
        real_user_dir: "{{ ansible_env.HOME }}"

    - name: Read SSH public key
      ansible.builtin.slurp:
        src: "{{ real_user_dir }}/.ssh/id_ed25519.pub"
      register: ssh_public_key_slurp

    - name: Set SSH public key fact
      ansible.builtin.set_fact:
        ssh_public_key: "{{ ssh_public_key_slurp['content'] | b64decode }}"

# Play 2: Prepare the chroot environment on the control node
- name: Prepare golden image chroot environment
  hosts: "{{ target_host | default('localhost') }}"
  become: true
  vars_files:
    - vars/main.yml
    - "hardware_vars/{{ hardware_version }}.yml"
  pre_tasks:
    - name: Check for passwordless sudo
      ansible.builtin.command: sudo -n true
      register: sudo_check
      ignore_errors: true
      changed_when: false

    - name: Fail if passwordless sudo is not configured
      ansible.builtin.fail:
        msg: |
          Passwordless sudo is not configured for the current user.
          Please configure it by running 'sudo visudo' on the control node
          and adding the following line to the end of the file:
          <username> ALL=(ALL) NOPASSWD: ALL
          (replace <username> with your actual username)
      when: sudo_check.rc != 0

    - name: Ensure chroot filesystems are unmounted
      ansible.builtin.include_role:
        name: chroot_cleanup

  tasks:
    - name: Install debootstrap dependencies
      ansible.builtin.apt:
        name:
          - debootstrap
        state: present
        update_cache: true

    - name: Create NFS root directory
      ansible.builtin.file:
        path: /srv/nfs/ubuntu_golden
        state: directory
        mode: "0755"

    - name: Run debootstrap to create Ubuntu 24.04 filesystem
      ansible.builtin.command: debootstrap --arch=amd64 noble /srv/nfs/ubuntu_golden
      args:
        creates: /srv/nfs/ubuntu_golden/etc/os-release

    - name: Copy host's resolv.conf for network access in chroot
      ansible.builtin.copy:
        src: /etc/resolv.conf
        dest: /srv/nfs/ubuntu_golden/etc/resolv.conf
        remote_src: true
        mode: "0644"

    - name: Mount pseudo-filesystems for chroot
      ansible.posix.mount:
        path: "/srv/nfs/ubuntu_golden/{{ item }}"
        src: "/{{ item }}"
        fstype: none
        opts: bind
        state: mounted
      loop:
        - proc
        - sys
        - dev

    - name: Add golden_image_chroot host to inventory
      ansible.builtin.add_host:
        name: golden_image_chroot
        ansible_connection: chroot
        ansible_host: /srv/nfs/ubuntu_golden
        ssh_key_for_chroot: "{{ ssh_public_key }}"
      changed_when: false

# Play 3: Configure the golden image via chroot and cleanup
- name: Configure golden image and cleanup
  hosts: golden_image_chroot
  become: true
  vars_files:
    - "vars/main.yml"
    - "hardware_vars/{{ hardware_version }}.yml"
  tasks:
    - name: Configure chroot environment
      block:
        - name: Include chroot_config role
          ansible.builtin.include_role:
            name: chroot_config
        - name: Include networkd_wol role
          ansible.builtin.include_role:
            name: networkd_wol
        - name: Include devtools role
          ansible.builtin.include_role:
            name: devtools
        - name: Include venv role
          ansible.builtin.include_role:
            name: venv
        - name: Include vllm_source role
          ansible.builtin.include_role:
            name: vllm_source
        - name: Include hardware-specific golden image roles
          ansible.builtin.include_role:
            name: "{{ item }}"
          loop: "{{ hardware_golden_image_roles | default([]) }}"
      always:
        - name: Run chroot cleanup tasks on localhost
          ansible.builtin.include_role:
            name: chroot_cleanup
            apply:
              delegate_to: localhost
              become: true
