---
- name: Generate local user SSH key
  hosts: "{{ target_host | default('localhost') }}"
  become: false
  vars_files:
    - vars/main.yml
    - "hardware_vars/{{ hardware_version }}.yml"
  tasks:
    - name: Set real user dir fact
      ansible.builtin.set_fact:
        real_user_dir: "{{ ansible_env.HOME }}"

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "{{ real_user_dir }}/.ssh"
        state: directory
        mode: "0700"

    - name: Generate ed25519 SSH key if it does not exist
      community.crypto.openssh_keypair:
        path: "{{ real_user_dir }}/.ssh/id_ed25519"
        type: ed25519
        state: present
        force: false

- name: Build golden_image chroot base image
  hosts: "{{ target_host | default('localhost') }}"
  become: true
  vars_files:
    - vars/main.yml
    - "hardware_vars/{{ hardware_version }}.yml"
  pre_tasks:
    - name: Check for passwordless sudo
      ansible.builtin.command: sudo -n true
      register: sudo_check
      ignore_errors: true
      changed_when: false

    - name: Fail if passwordless sudo is not configured
      ansible.builtin.fail:
        msg: |
          Passwordless sudo is not configured for the current user.
          Please configure it by running 'sudo visudo' on the control node
          and adding the following line to the end of the file:
          <username> ALL=(ALL) NOPASSWD: ALL
          (replace <username> with your actual username)
      when: sudo_check.rc != 0

    - name: Ensure chroot filesystems are unmounted
      ansible.builtin.include_role:
        name: control/chroot_connection_cleanup

    - name: Install Ansible
      ansible.builtin.apt:
        name: ansible
        state: present
        update_cache: true

    - name: Install community.general Ansible collection
      ansible.builtin.command:
        cmd: ansible-galaxy collection install community.general
        creates: "{{ ansible_user_dir }}/.ansible/collections/ansible_collections/community/general"
      changed_when: false

    - name: Install community.crypto Ansible collection
      ansible.builtin.command:
        cmd: ansible-galaxy collection install community.crypto
        creates: "{{ ansible_user_dir }}/.ansible/collections/ansible_collections/community/crypto"
      changed_when: false

  tasks:
    - name: Install debootstrap dependencies
      ansible.builtin.apt:
        name:
          - debootstrap
        state: present
        update_cache: true

    - name: Create golden image build directory
      ansible.builtin.file:
        path: "{{ golden_image_build_dir }}"
        state: directory
        mode: "0755"

    - name: Run debootstrap to create Ubuntu 24.04 filesystem
      ansible.builtin.command: "debootstrap --arch=amd64 noble {{ golden_image_build_dir }}"
      args:
        creates: "{{ golden_image_build_dir }}/etc/os-release"

    - name: Copy host's resolv.conf for network access in chroot
      ansible.builtin.copy:
        src: /etc/resolv.conf
        dest: "{{ golden_image_build_dir }}/etc/resolv.conf"
        remote_src: true
        mode: "0644"

    - name: Mount pseudo-filesystems for chroot
      ansible.posix.mount:
        path: "{{ golden_image_build_dir }}/{{ item }}"
        src: "/{{ item }}"
        fstype: none
        opts: bind
        state: ephemeral
      loop:
        - proc
        - sys
        - dev
        - sys/fs/cgroup
