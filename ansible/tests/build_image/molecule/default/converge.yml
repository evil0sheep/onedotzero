---
- name: Converge
  hosts: test-control-node
  gather_facts: true
  tasks:
    - name: Update apt cache
      ansible.builtin.raw: apt-get update -y
      changed_when: false

    - name: Install dependencies
      ansible.builtin.raw: apt-get install -y ansible rsync sudo python3
      changed_when: false

    - name: Debug versions
      ansible.builtin.debug:
        msg: |
          Ansible Version: {{ ansible_version.full }}
          Python Version: {{ ansible_python.version.major }}.{{ ansible_python.version.minor }}.{{ ansible_python.version.micro }}

    - name: Sync project source to the control node
      ansible.posix.synchronize:
        src: ../../../../../../
        dest: /root/onedotzero
        delete: true
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.venv"
          - "--exclude=__pycache__"
          - "--exclude=.ropeproject"
      changed_when: false

    - name: Run the build_image playbook on the control node
      ansible.builtin.command:
        cmd: >
          ansible-playbook
          ansible/build_image.yml
          --extra-vars "hardware_version=build_image_test"
        chdir: /root/onedotzero
      changed_when: false
