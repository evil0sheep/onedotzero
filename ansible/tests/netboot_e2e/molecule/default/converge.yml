---
- name: Converge
  hosts: all
  gather_facts: false

- name: Run build and configure on the control node
  hosts: test-control-node
  gather_facts: true
  # Connect as the default vagrant user, no user override needed.
  tasks:
    - name: Ensure software-properties-common is installed
      ansible.builtin.apt:
        name: software-properties-common
        state: present
        update_cache: true
      become: true

    - name: Add deadsnakes PPA for newer Python versions
      ansible.builtin.apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present
      become: true

    - name: Update apt cache
      ansible.builtin.raw: apt-get update -y
      changed_when: false
      become: true

    - name: Install dependencies
      ansible.builtin.raw: apt-get install -y ansible rsync sudo  python3.12
      changed_when: false
      become: true

    - name: Debug versions
      ansible.builtin.debug:
        msg: |
          Ansible Version: {{ ansible_version.full }}
          Python Version: {{ ansible_python.version.major }}.{{ ansible_python.version.minor }}.{{ ansible_python.version.micro }}

    - name: Sync project source to the control node
      ansible.posix.synchronize:
        src: ../../../../../../
        dest: /home/vagrant/onedotzero
        delete: true
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.venv"
          - "--exclude=__pycache__"
          - "--exclude=.ropeproject"

    # # molecule login --host test-control-node
    # - name: Pause for interactive debugging
    #   ansible.builtin.pause:
    #     minutes: 1440

    - name: Run the build_image playbook on the control node
      ansible.builtin.command:
        cmd: >
          sudo -E ansible-playbook
          ansible/build_image.yml
          --extra-vars "hardware_version=netboot_e2e_test"
        chdir: /home/vagrant/onedotzero
      changed_when: false

    # - name: Run the control_configure playbook on the control node
    #   ansible.builtin.command:
    #     cmd: >
    #       sudo -E ansible-playbook
    #       -i ansible/inventory/netboot_e2e_test/hosts.ini
    #       ansible/control_configure.yml
    #       --extra-vars "hardware_version=netboot_e2e_test"
    #     chdir: /home/vagrant/onedotzero
    #   changed_when: false
# - name: Verify compute node can mount the NFS share
#   hosts: test-compute-node
#   gather_facts: true
#   vars_files:
#     - vars/netboot_e2e.yml
#   tasks:
#     - name: Ensure NFS client is installed
#       ansible.builtin.apt:
#         name: nfs-common
#         state: present
#         update_cache: true
#       become: true

#     - name: Create mount point for NFS root
#       ansible.builtin.file:
#         path: /mnt/nfs_root
#         state: directory
#         mode: "0755"
#       become: true

#     - name: Mount the NFS share from the control node
#       ansible.posix.mount:
#         src: "{{ control_node_ip }}:/srv/nfs/ubuntu_golden"
#         path: /mnt/nfs_root
#         fstype: nfs
#         opts: "ro,sync"
#         state: mounted
#       become: true
