---
- name: Verify
  hosts: all
  # The test needs access to the same variables as the converge playbook
  # to resolve the 'compute_subnet' variable.
  vars_files:
    - ../../../../../vars/main.yml

  tasks:
    - name: Verify SSH client configuration syntax
      # This command must be run as the user who owns the config file,
      # not the root user that Molecule's verifier defaults to.
      # The SUDO_USER env var should be set by the ssh connection.
      become: true
      become_user: "{{ ansible_env.SUDO_USER | default('root') }}"
      ansible.builtin.command: "ssh -G {{ compute_subnet }}.1"
      changed_when: false
      # The command will fail with a non-zero exit code if syntax is invalid,
      # which will correctly fail the verification step.
