---
- name: Gather network facts
  ansible.builtin.setup:
    gather_subset:
      - network

- name: DEBUG - List all available interfaces
  ansible.builtin.debug:
    var: ansible_facts.interfaces

- name: DEBUG - Log all interfaces and their IPv4 addresses
  ansible.builtin.debug:
    msg: "Interface: {{ item }}, IPv4: {{ ansible_facts[item]['ipv4']['address'] | default('N/A') }}"
  loop: "{{ ansible_facts.interfaces }}"

- name: Ensure dnsmasq is stopped before configuration
  ansible.builtin.service:
    name: dnsmasq
    state: stopped

- name: Gather facts about listening ports
  community.general.listen_ports_facts:

- name: Fail if conflicting process is using a required port
  ansible.builtin.fail:
    msg: "Port conflict detected on port {{ item.port }} by process {{ item.name }}"
  loop: "{{ ansible_facts.tcp_listen + ansible_facts.udp_listen }}"
  when:
    - item.port in [53, 67, 69]
    - item.name != 'dnsmasq'

- name: Configure dnsmasq for onedotzero
  ansible.builtin.template:
    src: dnsmasq.conf.j2
    dest: /etc/dnsmasq.d/10-onedotzero.conf
    mode: "0644"
  notify: Restart dnsmasq

- name: Create systemd override directory for dnsmasq
  ansible.builtin.file:
    path: /etc/systemd/system/dnsmasq.service.d
    state: directory
    mode: "0755"

- name: Add systemd override for dnsmasq
  ansible.builtin.copy:
    content: |
      [Unit]
      After=network-online.target
      Wants=network-online.target
    dest: /etc/systemd/system/dnsmasq.service.d/override.conf
    mode: "0644"
  notify: Restart dnsmasq

- name: Ensure dnsmasq is running and enabled
  ansible.builtin.service:
    name: dnsmasq
    state: started
    enabled: true
  register: dnsmasq_service_status
  ignore_errors: true

- name: Show dnsmasq status if service failed to start
  when: dnsmasq_service_status.failed
  ansible.builtin.command: "systemctl status dnsmasq.service"
  register: systemctl_status
  changed_when: false

- name: Show dnsmasq journal if service failed to start
  when: dnsmasq_service_status.failed
  ansible.builtin.command: "journalctl -xeu dnsmasq.service"
  register: journalctl_output
  changed_when: false

- name: Display service failure logs
  when: dnsmasq_service_status.failed
  ansible.builtin.debug:
    msg: |
      Dnsmasq service failed to start.
      Systemd Status:
      {{ systemctl_status.stdout }}
      {{ systemctl_status.stderr }}
      Journalctl Output:
      {{ journalctl_output.stdout }}
      {{ journalctl_output.stderr }}

- name: Fail playbook if dnsmasq did not start
  when: dnsmasq_service_status.failed
  ansible.builtin.fail:
    msg: "dnsmasq service failed to start. See logs above for details."
