---
- name: Install NFS and debootstrap dependencies
  apt:
    name:
      - nfs-kernel-server
      - debootstrap
    state: present
    update_cache: yes

- name: Create NFS root directory
  file:
    path: /srv/nfs/ubuntu_golden
    state: directory
    mode: "0755"

- name: Check if debootstrap has already run
  stat:
    path: /srv/nfs/ubuntu_golden/etc/os-release
  register: debootstrap_check

- name: Run debootstrap to create Ubuntu 24.04 filesystem
  command: debootstrap --arch=amd64 noble /srv/nfs/ubuntu_golden
  when: not debootstrap_check.stat.exists

- name: Copy host's resolv.conf for network access in chroot
  copy:
    src: /etc/resolv.conf
    dest: /srv/nfs/ubuntu_golden/etc/resolv.conf
    remote_src: yes

- name: Mount pseudo-filesystems for chroot
  mount:
    path: "/srv/nfs/ubuntu_golden/{{ item }}"
    src: "/{{ item }}"
    fstype: none
    opts: bind
    state: mounted
  loop:
    - proc
    - sys
    - dev

- name: Add golden image chroot to inventory
  add_host:
    name: golden_image_chroot
    ansible_connection: chroot
    ansible_host: /srv/nfs/ubuntu_golden
  changed_when: false

# All chroot operations are now done via Ansible modules delegated to the chroot host
- name: Configure the golden image via chroot
  delegate_to: golden_image_chroot
  block:
    - name: Configure APT sources for chroot
      copy:
        dest: /etc/apt/sources.list
        content: |
          deb http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu noble-security main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu noble-backports main restricted universe multiverse
        mode: "0644"

    - name: Update apt cache and upgrade system in chroot
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install base packages in chroot
      apt:
        name:
          - linux-image-generic
          - openssh-server
          - nfs-common
          - overlayroot
        state: present

    - name: Include hardware-specific golden image roles
      ansible.builtin.include_role:
        name: "{{ item }}"
      loop: "{{ hardware_golden_image_roles | default([]) }}"

    - name: Ensure root .ssh directory exists in chroot
      file:
        path: /root/.ssh
        state: directory
        mode: "0700"

    - name: Add SSH key to root user in chroot
      copy:
        content: "{{ ssh_public_key }}"
        dest: /root/.ssh/authorized_keys
        mode: "0600"

    - name: Create compute user in chroot
      user:
        name: compute
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Ensure .ssh directory exists for compute user in chroot
      file:
        path: /home/compute/.ssh
        state: directory
        owner: compute
        group: compute
        mode: "0700"

    - name: Add SSH key for compute user in chroot
      copy:
        content: "{{ ssh_public_key }}"
        dest: /home/compute/.ssh/authorized_keys
        owner: compute
        group: compute
        mode: "0600"

    - name: Grant passwordless sudo to compute user in chroot
      copy:
        content: "compute ALL=(ALL) NOPASSWD: ALL"
        dest: /etc/sudoers.d/compute
        mode: "0440"

    - name: Set hostname in chroot
      copy:
        content: "compute-node"
        dest: /etc/hostname
        mode: "0644"

    - name: Configure overlayroot
      copy:
        content: |
          overlayroot="tmpfs:swap=1,recurse=0"
        dest: /etc/overlayroot.conf
        mode: "0644"

    - name: Create fstab in chroot
      copy:
        dest: /etc/fstab
        content: |
          proc /proc proc defaults 0 0
          sysfs /sys sysfs defaults 0 0

    - name: Update the initramfs in the chroot
      command: "update-initramfs -u"
      changed_when: false

- name: Unmount pseudo-filesystems
  mount:
    path: "/srv/nfs/ubuntu_golden/{{ item }}"
    state: unmounted
  loop:
    - proc
    - sys
    - dev

- name: Configure NFS exports
  template:
    src: exports.j2
    dest: /etc/exports

- name: Re-export NFS shares
  command: exportfs -ra
  changed_when: false

- name: Ensure nfs-kernel-server is started and enabled
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes
