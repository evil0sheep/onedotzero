---
- name: Create the vLLM virtual environment
  ansible.builtin.command:
    cmd: "python3 -m venv {{ vllm_venv_path }}"
    creates: "{{ vllm_venv_path }}/bin/pip"

- name: Check if the correct version of torch is installed
  ansible.builtin.command:
    cmd: "{{ vllm_venv_path }}/bin/pip show torch"
  register: torch_info
  changed_when: false
  failed_when: false

- name: Determine if torch needs to be updated
  ansible.builtin.set_fact:
    torch_needs_update: "{{ '+rocm6.4' not in torch_info.stdout }}"

- name: Uninstall torch if it is not the ROCm version
  ansible.builtin.pip:
    name: torch
    state: absent
    virtualenv: "{{ vllm_venv_path }}"
  when: torch_needs_update

- name: Install torch and torchvision for ROCm if not already installed
  ansible.builtin.pip:
    name:
      - torch
      - torchvision
    extra_args: --no-cache-dir --index-url https://download.pytorch.org/whl/rocm6.4
    virtualenv: "{{ vllm_venv_path }}"
  when: torch_needs_update

- name: Install build dependencies
  ansible.builtin.pip:
    name:
      - ninja
      - cmake < 4.0
      - wheel
      - pybind11
      - setuptools
    virtualenv: "{{ vllm_venv_path }}"

- name: Uninstall any existing Triton version
  ansible.builtin.pip:
    name: triton
    state: absent
    virtualenv: "{{ vllm_venv_path }}"

- name: Clone the Triton repository at a specific commit
  ansible.builtin.git:
    repo: https://github.com/triton-lang/triton.git
    dest: /usr/local/src/triton # Or any other temporary path
    version: e5be006
    clone: true
    update: false # Ensures it stays at the specified version

# using ansible native commands to build Triton isnt using venv properly, so use bash script
- name: Create Triton build script on remote host
  ansible.builtin.template:
    src: build_triton.sh.j2
    dest: /tmp/build_triton.sh
    mode: "0755"

- name: Execute Triton build script
  ansible.builtin.command:
    cmd: /tmp/build_triton.sh
    chdir: /usr/local/src/triton
    creates: "{{ vllm_venv_path }}/lib/python3.12/site-packages/triton"

- name: Build and install AMD SMI from local source
  ansible.builtin.pip:
    name: /opt/rocm/share/amd_smi
    virtualenv: "{{ vllm_venv_path }}"

- name: Install and upgrade Python dependencies in the correct venv
  ansible.builtin.pip:
    name:
      - numba
      - scipy
      - "huggingface-hub[cli,hf_transfer]"
      - setuptools_scm
    state: present
    virtualenv: "{{ vllm_venv_path }}"

- name: Install numpy with a version constraint
  ansible.builtin.pip:
    name: "numpy<2"
    virtualenv: "{{ vllm_venv_path }}"

- name: Install dependencies from requirements file
  ansible.builtin.pip:
    requirements: /usr/local/src/vllm/requirements/rocm.txt
    executable: "{{ vllm_venv_path }}/bin/pip"

- name: Create vLLM build script on remote host
  ansible.builtin.template:
    src: build_vllm.sh.j2
    dest: /tmp/build_vllm.sh
    mode: "0755"

- name: Execute vLLM build script
  ansible.builtin.command:
    cmd: /tmp/build_vllm.sh
    chdir: /usr/local/src/vllm
    creates: "{{ vllm_venv_path }}/lib/python3.12/site-packages/vllm"
