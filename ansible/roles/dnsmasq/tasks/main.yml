---
- name: Ensure dnsmasq is stopped before configuration
  ansible.builtin.service:
    name: dnsmasq
    state: stopped

- name: Gather facts about listening ports
  community.general.listen_ports_facts:

- name: Fail if conflicting process is using a required port
  ansible.builtin.fail:
    msg: "Port conflict detected on port {{ item.port }} by process {{ item.name }}"
  loop: "{{ ansible_facts.tcp_listen + ansible_facts.udp_listen }}"
  when:
    - item.port in [53, 67, 69]
    - item.name != 'dnsmasq'

- name: Configure dnsmasq for onedotzero
  ansible.builtin.template:
    src: dnsmasq.conf.j2
    dest: /etc/dnsmasq.d/10-onedotzero.conf
    mode: "0644"
  notify: Restart dnsmasq

- name: Create systemd override directory for dnsmasq
  ansible.builtin.file:
    path: /etc/systemd/system/dnsmasq.service.d
    state: directory
    mode: "0755"

- name: Add systemd override for dnsmasq
  ansible.builtin.copy:
    content: |
      [Unit]
      After=network-online.target
      Wants=network-online.target
    dest: /etc/systemd/system/dnsmasq.service.d/override.conf
    mode: "0644"
  notify: Restart dnsmasq

- name: Ensure dnsmasq is running and enabled
  ansible.builtin.service:
    name: dnsmasq
    state: started
    enabled: true
