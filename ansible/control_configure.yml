---
# Play 1: Run tasks as the ansible_user
- name: Configure local SSH client for compute nodes
  hosts: localhost
  connection: local
  become: false
  vars_files:
    - vars/main.yml
    - "hardware_vars/{{ hardware_version }}.yml"
  tasks:
    - name: Configure SSH client for compute nodes
      ansible.builtin.blockinfile:
        path: "{{ ansible_user_dir }}/.ssh/config"
        create: true
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: "0600"
        block: |
          {% for node in compute_nodes %}
          Host {{ node.name }}
            HostName {{ node.ip }}
            User compute
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          {% endfor %}

# Play 2: Run tasks as root
- name: Configure base system and network gateway
  hosts: localhost
  connection: local
  become: true
  vars_files:
    - vars/main.yml
    - "hardware_vars/{{ hardware_version }}.yml"
  pre_tasks:
    - name: Check for passwordless sudo
      ansible.builtin.command: sudo -n true
      register: sudo_check
      ignore_errors: true
      changed_when: false

    - name: Fail if passwordless sudo is not configured
      ansible.builtin.fail:
        msg: |
          Passwordless sudo is not configured for the current user.
          Please configure it by running 'sudo visudo' on the control node
          and adding the following line to the end of the file:
          <username> ALL=(ALL) NOPASSWD: ALL
          (replace <username> with your actual username)
      when: sudo_check.rc != 0

    - name: Install Ansible
      ansible.builtin.apt:
        name: ansible
        state: present
        update_cache: true

    - name: Install community.general Ansible collection
      ansible.builtin.command:
        cmd: ansible-galaxy collection install community.general
        creates: "{{ ansible_user_dir }}/.ansible/collections/ansible_collections/community/general"
  roles:
    - base
    - gateway

- name: Configure NFS, PXE, and DNS services
  hosts: localhost
  connection: local
  become: true
  vars_files:
    - vars/main.yml
    - "hardware_vars/{{ hardware_version }}.yml"
  tasks:
    - name: Refresh network facts
      ansible.builtin.setup:
        filter: "ansible_network_resources"
  roles:
    - nfs_server
    - pxe_boot
    - dnsmasq

  post_tasks:
    - name: Ensure remote directory exists
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/remote/onedotzero"
        state: directory
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: "0755"

    - name: Restart dnsmasq
      ansible.builtin.service:
        name: dnsmasq
        state: restarted

- name: Apply hardware-specific configurations
  hosts: localhost
  connection: local
  become: true
  vars_files:
    - "hardware_vars/{{ hardware_version }}.yml"
  tasks:
    - name: Include hardware-specific configuration roles
      ansible.builtin.include_role:
        name: "{{ item }}"
      loop: "{{ hardware_control_configure_roles | default([]) }}"
